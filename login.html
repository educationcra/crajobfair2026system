<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - CRA Job Fair</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css'>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: 'Prompt', sans-serif; overflow-x: hidden; }
    @keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); opacity: 0; } 10% { opacity: 0.15; } 80% { opacity: 0.15; } 100% { transform: translateY(-20vh) rotate(20deg); opacity: 0; } }
    .bg-icon-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
    .floating-icon { position: absolute; top: 0; color: white; opacity: 0; animation: floatUp linear infinite; line-height: 1; }
    .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; z-index: 10; transition: all 0.3s ease; }
    .btn-gradient { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; }
    .input-field { width: 100%; padding: 1rem; border-radius: 1rem; border: 1px solid #e5e7eb; background: #f9fafb; outline: none; transition: 0.3s; }
    .input-field:focus { background: white; border-color: #f97316; box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1); }
    div:where(.swal2-container) { font-family: 'Prompt', sans-serif !important; }
    div:where(.swal2-popup) { border-radius: 20px !important; }
    .hidden { display: none !important; }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .history-card { animation: slideInLeft 0.4s ease-out forwards; }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    .coupon-card { position: relative; transition: all 0.3s ease; cursor: pointer; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
    .coupon-card:active { transform: scale(0.98); }
    .coupon-used { filter: grayscale(100%) opacity(0.6); pointer-events: none; }
    
    /* Scanner & Mask */
    .scanner-wrapper { position: relative; width: 100%; height: 320px; background: black; border-radius: 1rem; overflow: hidden; }
    #reader-admin, #reader-sponsor { width: 100%; height: 100%; object-fit: cover; }
    .scan-overlay { position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; justify-content: center; }
    .scan-box { width: 250px; height: 250px; position: relative; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); }
    .scan-corner { position: absolute; width: 30px; height: 30px; border-style: solid; border-width: 4px; border-radius: 4px; }
    .c-tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
    .c-tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
    .c-bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; }
    .c-br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }
/* --- CSS Loader Animation (‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏õ‡∏∏‡πà‡∏°) --- */
.loader {
  width: 22.4px;
  height: 22.4px;
  color: #ffffff; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡πâ‡∏° */
  position: relative;
  background: radial-gradient(5.6px, currentColor 94%, #0000);
}

.loader:before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: 
    radial-gradient(5.04px at bottom right, #0000 94%, currentColor) top left,
    radial-gradient(5.04px at bottom left, #0000 94%, currentColor) top right,
    radial-gradient(5.04px at top right, #0000 94%, currentColor) bottom left,
    radial-gradient(5.04px at top left, #0000 94%, currentColor) bottom right;
  background-size: 11.2px 11.2px;
  background-repeat: no-repeat;
  animation: loader 1.5s infinite cubic-bezier(0.3, 1, 0, 1);
}

@keyframes loader {
  33% {
    inset: -5.6px;
    transform: rotate(0deg);
  }
  66% {
    inset: -5.6px;
    transform: rotate(90deg);
  }
  100% {
    inset: 0;
    transform: rotate(90deg);
  }
}
  </style>
</head>
<body class="bg-gradient-to-br from-orange-500 via-red-500 to-rose-600 min-h-screen p-4 flex flex-col items-center justify-center">

  <div class="bg-icon-container">
      <i class="fi fi-sr-graduation-cap floating-icon text-9xl" style="left:5%;animation-duration:20s;"></i>
      <i class="fi fi-sr-coins floating-icon text-8xl" style="left:20%;animation-duration:25s;animation-delay:5s;"></i>
      <i class="fi fi-sr-microchip floating-icon text-9xl" style="left:65%;animation-duration:24s;animation-delay:1s;"></i>
  </div>

  <div class="w-full max-w-4xl relative z-10 flex justify-center">

<div id="view-login" class="w-full max-w-md animate-fade-in">
          <div class="glass-panel p-8 text-center border border-white relative overflow-hidden">
              
              <div onclick="toggleStaffMode()" class="absolute top-4 right-4 cursor-pointer group z-20 p-2 rounded-full hover:bg-orange-50 transition-colors">
                  <i class="fi fi-sr-settings text-2xl text-gray-300 group-hover:text-orange-500 transition-colors"></i>
              </div>

              <div class="mb-6 flex justify-center">
                  <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 shadow-inner" id="login-icon">
                      <i class="fi fi-sr-lock text-3xl mt-1"></i>
                  </div>
              </div>
              
              <h2 class="text-2xl font-bold text-gray-800 mb-2" id="login-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
              <p class="text-gray-500 mb-8 text-sm" id="login-subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</p>
              
              <form onsubmit="handleLogin(event)" class="space-y-4">
                  <input type="text" id="username" class="input-field" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (0XX-XXX-XXXX)" required oninput="formatPhoneLogin(this)" maxlength="12">
                  <div id="password-container" class="hidden">
                      <input type="password" id="password" class="input-field" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                  </div>
                  <button type="submit" id="btnLogin" class="w-full btn-gradient p-4 rounded-xl font-bold shadow-lg text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
              </form>
              
              <div class="mt-8 pt-6 border-t border-gray-100">
                 <a href="index.html" class="text-sm text-gray-400 hover:text-orange-500">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
              </div>
          </div>
      </div>

      <div id="view-admin" class="w-full max-w-lg hidden">
          <div class="glass-panel p-6 border border-white mb-4">
              <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800"><i class="fi fi-sr-shield-check text-orange-500 mr-2"></i>Admin</h2><button onclick="logout()" class="flex items-center gap-2 bg-red-500 text-white text-sm font-bold px-4 py-2 rounded-xl hover:bg-red-600 transition-colors shadow-sm">
                      <i class="fi fi-sr-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </button></div>
              
              <div class="flex justify-center mb-4">
                  <div class="bg-gray-100 p-1 rounded-xl flex shadow-inner">
                      <button onclick="selectDate('12')" id="btn-date-12" class="px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-orange-600 shadow-sm border border-gray-200">12 ‡∏Å.‡∏û.</button>
                      <button onclick="selectDate('13')" id="btn-date-13" class="px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-400 hover:text-gray-600">13 ‡∏Å.‡∏û.</button>
                  </div>
              </div>

              <div class="flex bg-gray-100 p-1 rounded-xl mb-4 relative">
                  <div id="toggle-bg" class="absolute w-1/2 h-[calc(100%-8px)] bg-white rounded-lg shadow-sm transition-all duration-300 top-1 left-1"></div>
                  <button onclick="switchAdminTab('scan')" class="w-1/2 py-2 rounded-lg text-sm font-bold z-10 relative transition-colors text-orange-600" id="btn-tab-scan"><i class="fi fi-sr-camera-viewfinder"></i> ‡∏™‡πÅ‡∏Å‡∏ô</button>
                  <button onclick="switchAdminTab('manual')" class="w-1/2 py-2 rounded-lg text-sm font-bold z-10 relative transition-colors text-gray-500" id="btn-tab-manual"><i class="fi fi-sr-keyboard mr-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™</button>
              </div>

              <div id="admin-scan-section">
                  <div class="scanner-wrapper shadow-lg mb-4">
                      <div id="reader-admin"></div>
                      <div class="scan-overlay">
                          <div class="scan-box">
                              <div class="scan-corner c-tl border-orange-500"></div><div class="scan-corner c-tr border-orange-500"></div><div class="scan-corner c-bl border-orange-500"></div><div class="scan-corner c-br border-orange-500"></div>
                              <div class="absolute w-full h-0.5 bg-orange-500/80 top-1/2 shadow-[0_0_10px_#f97316] animate-pulse"></div>
                          </div>
                      </div>
                  </div>
                  <p class="text-center text-xs text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="current-date-display" class="font-bold text-orange-600">12 ‡∏Å.‡∏û.</span></p>
              </div>

              <div id="admin-manual-section" class="hidden min-h-[16rem] flex flex-col items-center justify-center">
                  <div class="w-full max-w-xs">
                      <label class="block text-sm font-medium text-gray-600 mb-2 text-center">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢</label>
                      <div class="flex items-center gap-2 mb-4"><span class="text-2xl font-bold text-orange-500 bg-orange-50 px-3 py-2 rounded-xl">CV</span><input type="tel" id="manual-cv-input" class="w-full text-3xl font-bold text-center tracking-widest p-2 rounded-xl border-2 border-gray-200 focus:border-orange-500 focus:ring-0 outline-none" placeholder="0000" maxlength="4" oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>
                      <button onclick="submitManualCheckin()" class="w-full btn-gradient py-3 rounded-xl font-bold shadow-lg text-white flex items-center justify-center gap-2"><i class="fi fi-sr-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                  </div>
              </div>
              <div class="mt-6 border-t border-gray-100 pt-4">
                  <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center"><i class="fi fi-sr-time-past text-gray-400 mr-2"></i> ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                  <div id="checkin-history-list" class="space-y-2"><div class="text-center text-xs text-gray-300 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>
              </div>
          </div>
      </div>

<div id="view-sponsor" class="w-full max-w-lg hidden">
          <div class="glass-panel p-6 border border-white">
              
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                      <i class="fi fi-sr-store-alt text-orange-500 mr-3"></i>Sponsor
                  </h2>
                  <button onclick="logout()" class="flex items-center gap-2 bg-red-500 text-white text-sm font-bold px-4 py-2 rounded-xl hover:bg-red-600 transition-colors shadow-sm">
                      <i class="fi fi-sr-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
              </div>
              
              <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-6 flex items-center justify-center gap-3 relative overflow-hidden">
                  <div class="absolute right-0 top-0 opacity-10">
                      <i class="fi fi-sr-hamburger-soda text-6xl text-yellow-600"></i>
                  </div>
                  <i class="fi fi-sr-hamburger-soda text-2xl text-yellow-600"></i>
                  <span class="text-yellow-900 font-bold text-lg">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
              </div>

              <div class="flex bg-gray-100 p-1 rounded-xl mb-6 relative">
                  <div id="sp-toggle-bg" class="absolute w-1/2 h-[calc(100%-8px)] bg-white rounded-lg shadow-sm transition-all duration-300 top-1 left-1"></div>
                  <button onclick="switchSponsorTab('scan')" class="w-1/2 py-2 rounded-lg text-sm font-bold z-10 relative transition-colors text-orange-600" id="btn-sp-scan"><i class="fi fi-sr-camera-viewfinder mr-1"></i> ‡∏™‡πÅ‡∏Å‡∏ô</button>
                  <button onclick="switchSponsorTab('manual')" class="w-1/2 py-2 rounded-lg text-sm font-bold z-10 relative transition-colors text-gray-500" id="btn-sp-manual"><i class="fi fi-sr-keyboard mr-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™</button>
              </div>
              
              <div id="sponsor-scan-section">
                  <div class="scanner-wrapper shadow-lg mb-4">
                      <div id="reader-sponsor"></div>
                      <div class="scan-overlay">
                          <div class="scan-box">
                              <div class="scan-corner c-tl border-green-500"></div><div class="scan-corner c-tr border-green-500"></div><div class="scan-corner c-bl border-green-500"></div><div class="scan-corner c-br border-green-500"></div>
                              <div class="absolute w-full h-0.5 bg-green-500/80 top-1/2 shadow-[0_0_10px_#22c55e] animate-pulse"></div>
                          </div>
                      </div>
                  </div>
                  <p class="text-center text-sm text-gray-400">‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö)</p>
              </div>

              <div id="sponsor-manual-section" class="hidden min-h-[18rem] flex flex-col items-center justify-center">
                  <div class="w-full px-2"> <label class="block text-base font-bold text-gray-700 mb-4 text-center">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
                      
                      <div class="flex items-center justify-center gap-1 mb-8">
                          <div class="flex items-center">
                              <span class="text-orange-500 font-black text-xl mr-1">CV</span>
                              <span class="text-gray-300 font-bold text-xl mx-0.5">-</span>
                              <input type="tel" id="sp-input-id" class="w-24 py-2 rounded-xl border-2 border-gray-200 text-center font-bold text-xl focus:border-orange-500 outline-none tracking-widest" placeholder="0000" maxlength="4" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                          </div>
                          
                          <span class="text-gray-300 font-bold text-xl">-</span>

                          <select id="sp-input-date" class="bg-gray-50 border-2 border-gray-200 text-gray-800 text-xl font-bold rounded-xl py-2 px-1 focus:border-orange-500 outline-none appearance-none text-center w-16">
                              <option value="12">12</option>
                              <option value="13">13</option>
                          </select>

                          <span class="text-gray-300 font-bold text-xl">-</span>

                          <input type="tel" id="sp-input-index" class="w-12 py-2 rounded-xl border-2 border-gray-200 text-center font-bold text-xl focus:border-orange-500 outline-none" placeholder="1" maxlength="1" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                      </div>

                      <button onclick="submitSponsorManual()" class="w-full btn-gradient py-3 rounded-2xl font-bold shadow-lg text-white flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform text-lg">
                          <i class="fi fi-sr-ticket-alt text-xl"></i> ‡∏ï‡∏±‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                      </button>
                  </div>
              </div>
              <div class="mt-8 border-t border-gray-100 pt-6">
                  <h3 class="text-base font-bold text-gray-700 mb-4 flex items-center">
                      <i class="fi fi-sr-time-past text-orange-500 mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                  </h3>
                  <div id="sponsor-history-list" class="space-y-2">
                      <div class="text-center text-sm text-gray-300 py-6 border-2 border-dashed border-gray-100 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                  </div>
              </div>
          </div>
      </div>
      <div id="view-user" class="w-full max-w-md hidden">
          <div class="glass-panel p-6 border border-white min-h-[80vh] relative flex flex-col">
              <div class="flex justify-between items-start mb-6">
                  <div><h2 class="text-2xl font-bold text-gray-800" id="user-name">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h2><div class="inline-flex items-center gap-1 bg-orange-100 text-orange-700 px-2 py-0.5 rounded-md text-xs mt-1 font-medium"><i class="fi fi-sr-id-badge"></i> <span id="user-id">CV----</span></div></div>
                  <button onclick="logout()" class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-red-50 transition"><i class="fi fi-sr-power"></i></button>
              </div>
              <div onclick="showMyQR()" class="bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-6 text-white shadow-xl mb-8 relative overflow-hidden group cursor-pointer active:scale-95 transition">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full transform translate-x-10 -translate-y-10"></div>
                  <div class="flex items-center gap-4 relative z-10"><div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center"><i class="fi fi-sr-mode-portrait text-xl flex items-center justify-center"></i></div><div><h3 class="text-xl font-bold">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h3><p class="text-white/80 text-xs mt-0.5">‡∏Å‡∏î‡πÅ‡∏™‡∏î‡∏á QR Code</p></div></div>
              </div>
              <div class="flex-1">
                  <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                      <i class="fi fi-sr-ticket text-orange-500 mr-2 text-xl mt-0.5"></i> ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                  </h3>
                  <div id="coupon-list" class="space-y-4 pb-4"></div>
              </div>
          </div>
      </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxldZnRE3QbH7NEKWLzoqs_cz_osoro40-JP89YjnGuQurGpR7uA1ToaDWrX-NDrKnZQQ/exec";
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Google Apps Script (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CORS)
// ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô login.html
async function callAPI(action, payload) {
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            // [‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ]
            headers: { "Content-Type": "text/plain;charset=utf-8" }, 
            body: JSON.stringify({ action: action, payload: payload })
        });
        const result = await response.json();
        return result;
    } catch (error) {
        console.error("API Error:", error);
        return { status: 'error', message: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' };
    }
}
    let currentUser = null, html5QrCode = null, isStaffMode = false, checkinHistory = [];
    let selectedAdminDate = '12'; // Default Date for Admin

    function formatPhoneLogin(input) {
        if(isStaffMode) return; 
        let v = input.value.replace(/\D/g, ''); 
        if(v.length>10) v=v.substring(0,10);
        input.value = v.length>6 ? v.slice(0,3)+"-"+v.slice(3,6)+"-"+v.slice(6) : (v.length>3 ? v.slice(0,3)+"-"+v.slice(3) : v);
    }

    function toggleStaffMode() {
        isStaffMode = !isStaffMode;
        const pass = document.getElementById('password-container'), user = document.getElementById('username'), icon = document.getElementById('login-icon');
        if (isStaffMode) {
            pass.classList.remove('hidden'); pass.classList.add('animate-slide-down');
            document.getElementById('login-title').innerText = "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà";
            document.getElementById('login-subtitle').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username";
            user.placeholder = "Username"; user.value = "";
            icon.classList.replace('bg-orange-100','bg-gray-800'); icon.classList.replace('text-orange-600','text-white'); icon.innerHTML='<i class="fi fi-sr-settings-sliders text-3xl mt-1"></i>';
        } else {
            pass.classList.add('hidden');
            document.getElementById('login-title').innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            document.getElementById('login-subtitle').innerText = "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô";
            user.placeholder = "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (0XX-XXX-XXXX)"; user.value = ""; document.getElementById('password').value = "";
            icon.classList.replace('bg-gray-800','bg-orange-100'); icon.classList.replace('text-white','text-orange-600'); icon.innerHTML='<i class="fi fi-sr-lock text-3xl mt-1"></i>';
        }
    }
async function handleLogin(e) { // ‡πÄ‡∏û‡∏¥‡πà‡∏° async
        e.preventDefault();
        const btn = document.getElementById('btnLogin');
        const originalText = btn.innerHTML;
        
        // Show Loading
        btn.innerHTML = '<div class="flex items-center justify-center gap-3"><span class="loader"></span> <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>'; 
        btn.disabled = true;

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
        const res = await callAPI('login', { 
            username: document.getElementById('username').value, 
            password: document.getElementById('password').value 
        });

        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (res.status === 'success') { 
            currentUser = res; 
            switchView(res.role); 
        } else { 
            Swal.fire({icon:'error', title:'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:res.message, confirmButtonColor:'#f97316'}); 
        }
    }
function switchView(role) {
        document.getElementById('view-login').classList.add('hidden');
  stopUserPolling();
        if (role === 'admin') {
            document.getElementById('view-admin').classList.remove('hidden');
           // --- [Start] Logic ‡∏•‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏Å.‡∏û. 2569) ---
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1; // 1-12
            const day = today.getDate();
            const btn12 = document.getElementById('btn-date-12');
            const btn13 = document.getElementById('btn-date-13');
            // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)
            btn12.style.display = 'inline-block';
            btn13.style.display = 'inline-block';
            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Å.‡∏û. ‡∏õ‡∏µ 2026 (‡∏û.‡∏®. 2569)
            if (year === 2026 && month === 2) {
                if (day === 12) {
                    // üîí ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 12: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 12, ‡∏ã‡πà‡∏≠‡∏ô 13 (Bank ‡πÑ‡∏ß‡πâ)
                    selectDate('12');
                    btn13.style.display = 'none'; 
                } else if (day === 13) {
                    // üîí ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 13: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 13, ‡∏ã‡πà‡∏≠‡∏ô 12 (Back ‡πÑ‡∏ß‡πâ)
                    selectDate('13');
                    btn12.style.display = 'none';
                } else {
                    // üîì ‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Å‡πà‡∏≠‡∏ô 12 ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á 13): ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
                    selectDate('12'); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 12 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                }
            } else {
                // üîì ‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ): ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
                selectDate('12');
            }

            startScanner('reader-admin', 'admin'); 
            
        } else if (role === 'sponsor') {
            document.getElementById('view-sponsor').classList.remove('hidden');
            switchSponsorTab('scan');
        } else if (role === 'user') {
            document.getElementById('view-user').classList.remove('hidden');
            renderUserPage(currentUser.userData);
          startUserPolling();
        }
    }

    function logout() {
      stopUserPolling(); // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏´‡∏¢‡∏∏‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å
        if(html5QrCode) try{html5QrCode.stop().then(()=>html5QrCode.clear())}catch(e){}
        currentUser=null; checkinHistory=[];
        ['view-admin','view-sponsor','view-user'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        const lv=document.getElementById('view-login'); lv.classList.remove('hidden','animate-fade-in'); void lv.offsetWidth; lv.classList.add('animate-fade-in');
        document.getElementById('username').value=''; document.getElementById('password').value='';
        if(isStaffMode) toggleStaffMode();
    }
// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Interval (‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)
    let pollingInterval = null;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ User View)
    function startUserPolling() {
        if (pollingInterval) clearInterval(pollingInterval); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        
        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÜ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (3000ms)
        pollingInterval = setInterval(async () => {
            if (!currentUser || !currentUser.userData || !currentUser.userData.id) return;

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå Loading)
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'get_user_update', 
                        payload: { userId: currentUser.userData.id } 
                    })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                    const oldJson = JSON.stringify(currentUser.userData.coupons);
                    const newJson = JSON.stringify(data.coupons);
                    
                    if (oldJson !== newJson) {
                        console.log("Data updated!");
                        currentUser.userData.coupons = data.coupons; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
                        renderUserPage(currentUser.userData); // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    }
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 3000); // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ Logout ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤)
    function stopUserPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }
    // --- ADMIN DATE SELECTION ---
    function selectDate(date) {
        selectedAdminDate = date;
        const btn12 = document.getElementById('btn-date-12');
        const btn13 = document.getElementById('btn-date-13');
        document.getElementById('current-date-display').innerText = date + " ‡∏Å.‡∏û.";
        
        if (date === '12') {
            btn12.classList.replace('text-gray-400','text-orange-600'); btn12.classList.add('bg-white','shadow-sm','border','border-gray-200');
            btn13.classList.replace('text-orange-600','text-gray-400'); btn13.classList.remove('bg-white','shadow-sm','border','border-gray-200');
        } else {
            btn13.classList.replace('text-gray-400','text-orange-600'); btn13.classList.add('bg-white','shadow-sm','border','border-gray-200');
            btn12.classList.replace('text-orange-600','text-gray-400'); btn12.classList.remove('bg-white','shadow-sm','border','border-gray-200');
        }
    }

    function switchAdminTab(mode) {
        const bg=document.getElementById('toggle-bg'), scanSec=document.getElementById('admin-scan-section'), manualSec=document.getElementById('admin-manual-section');
        const btnScan=document.getElementById('btn-tab-scan'), btnManual=document.getElementById('btn-tab-manual');
        if(mode==='scan') {
            bg.style.left='4px'; btnScan.classList.replace('text-gray-500','text-orange-600'); btnManual.classList.replace('text-orange-600','text-gray-500');
            scanSec.classList.remove('hidden'); manualSec.classList.add('hidden'); startScanner('reader-admin','admin');
        } else {
            bg.style.left='50%'; btnScan.classList.replace('text-orange-600','text-gray-500'); btnManual.classList.replace('text-gray-500','text-orange-600');
            scanSec.classList.add('hidden'); manualSec.classList.remove('hidden');
            if(html5QrCode) try{html5QrCode.stop()}catch(e){}
        }
    }

    function submitManualCheckin() {
        const val = document.getElementById('manual-cv-input').value;
        if(val.length!==4) { Swal.fire({icon:'warning', title:'‡∏£‡∏∞‡∏ö‡∏∏ 4 ‡∏´‡∏•‡∏±‡∏Å', timer:1000, showConfirmButton:false}); return; }
        processCheckin('admin', "CV"+val);
        document.getElementById('manual-cv-input').value='';
    }

// 1. ‡πÅ‡∏Å‡πâ processCheckin ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å addHistoryItem ‡∏Ç‡∏≠‡∏á Sponsor ‡∏î‡πâ‡∏ß‡∏¢
// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å google.script.run ‡πÄ‡∏õ‡πá‡∏ô callAPI
    async function processCheckin(type, content) { // ‡πÄ‡∏û‡∏¥‡πà‡∏° async
        let extraData = "";
        if (type === 'admin') extraData = selectedAdminDate; 
        else if (type === 'sponsor' && currentUser) extraData = currentUser.name; 

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        if(type !== 'manual_admin' && html5QrCode) {
            try { html5QrCode.pause(); } catch(e) {}
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
        const res = await callAPI('scan', {
            type: type,
            content: content,
            extraData: extraData
        });

        const resume = () => { 
            if(type !== 'manual_admin' && html5QrCode) {
                try { html5QrCode.resume(); } catch(e) {}
            }
        };

        if (res.status === 'success') {
            Swal.fire({icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:res.message, confirmButtonText:'‡∏ï‡∏Å‡∏•‡∏á', confirmButtonColor:'#f97316'}).then(resume);
            if(res.checkinData) addHistoryItem(res.checkinData, type);
        } else if (res.status === 'warning') {
            Swal.fire({icon:'warning', title:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text:res.message, confirmButtonText:'‡∏ï‡∏Å‡∏•‡∏á', confirmButtonColor:'#f59e0b'}).then(resume);
            if(res.checkinData) addHistoryItem(res.checkinData, type);
        } else {
            Swal.fire({icon:'error', title:'‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text:res.message, confirmButtonText:'‡∏ï‡∏Å‡∏•‡∏á', confirmButtonColor:'#ef4444'}).then(resume);
        }
        
        if(res.dashboard) updateDashboard(res.dashboard);
    }
    // 2. ‡∏õ‡∏£‡∏±‡∏ö addHistoryItem ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á (Target Container)
    function addHistoryItem(data, type) {
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Admin ‡∏´‡∏£‡∏∑‡∏≠ Sponsor)
        const containerId = (type === 'sponsor') ? 'sponsor-history-list' : 'checkin-history-list';
        
        checkinHistory.unshift(data); 
        if(checkinHistory.length > 5) checkinHistory.pop();
        
        const box = document.getElementById(containerId); 
        if(!box) return; // ‡∏Å‡∏±‡∏ô Error
        
        box.innerHTML = '';
        
        checkinHistory.forEach(item => {
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Sponsor ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            const iconColor = (type === 'sponsor') ? 'text-orange-500 bg-orange-100' : 'text-green-600 bg-green-100';
            const iconClass = (type === 'sponsor') ? 'fi-sr-ticket' : 'fi-sr-check';

            box.innerHTML += `
            <div class="history-card bg-white border border-gray-100 rounded-xl p-3 flex items-center gap-3 shadow-sm mb-2">
                <div class="w-10 h-10 rounded-full ${iconColor} flex items-center justify-center shrink-0">
                    <i class="fi ${iconClass}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-800 text-sm truncate">${item.name}</div>
                    <div class="text-xs text-gray-500 flex justify-between items-center mt-1">
                        <span class="font-mono bg-gray-50 px-1.5 rounded text-gray-500 border border-gray-200">${item.id}</span>
                        <div class="flex items-center gap-1 text-gray-400 font-medium text-[10px]">
                            <span>${item.time}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }

 function renderUserPage(data) {
        document.getElementById('user-name').innerText = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ' + data.name;
        document.getElementById('user-id').innerText = data.id;
        
        const box = document.getElementById('coupon-list'); 
        box.innerHTML = '';
        
        if(!data.coupons || data.coupons.length === 0) { 
            box.innerHTML = '<div class="text-center text-gray-400 py-8 border border-dashed rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>'; 
            return; 
        }
        
        data.coupons.forEach(c => {
            const isUsed = c.status === 'Used';
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ (‡πÄ‡∏ä‡πà‡∏ô CV0001-12-1 ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç 12 ‡∏°‡∏≤)
            const dateCode = c.code.split('-')[1]; 

            // --- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ò‡∏µ‡∏°‡∏™‡∏µ ---
            let bgStart, bgEnd, txtColor, iconColor, iconBg;

            if (isUsed) {
                // üîò ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
                bgStart='#f3f4f6'; bgEnd='#e5e7eb'; 
                txtColor='#9ca3af'; iconColor='#9ca3af'; iconBg='#e5e7eb';
            } else if (dateCode === '13') {
                // üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 13: ‡∏™‡πâ‡∏°‡∏≠‡∏°‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô (Rose/Red Tone)
                bgStart='#fff1f2'; bgEnd='#fecdd3'; // ‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô‡πÜ
                txtColor='#9f1239'; // ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°
                iconColor='#f43f5e'; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏î‡∏á
                iconBg='#ffe4e6';    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
            } else {
                // üü† ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 12 (Default): ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô (Orange Tone)
                bgStart='#fff7ed'; bgEnd='#fed7aa'; // ‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô
                txtColor='#c2410c'; // ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
                iconColor='#f97316'; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡πâ‡∏°
                iconBg='#ffedd5';    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
            }

            const html = `
            <div class="coupon-card w-full h-28 relative ${isUsed?'coupon-used':''}" onclick="${isUsed?'':`showCouponQR('${c.code}')`}">
                <svg viewBox="0 0 400 120" class="w-full h-full drop-shadow-md" preserveAspectRatio="none">
                    <defs>
                        <mask id="cut-${c.code}">
                            <rect x="0" y="0" width="400" height="120" fill="white"/>
                            <circle cx="0" cy="60" r="12" fill="black"/>
                            <circle cx="400" cy="60" r="12" fill="black"/>
                            <path d="M300 10 L300 110" stroke="black" stroke-width="2" stroke-dasharray="6,6"/>
                        </mask>
                        <linearGradient id="grad-${c.code}">
                            <stop offset="0%" stop-color="${bgStart}"/>
                            <stop offset="100%" stop-color="${bgEnd}"/>
                        </linearGradient>
                    </defs>
                    <rect width="400" height="120" fill="url(#grad-${c.code})" mask="url(#cut-${c.code})" rx="12"/>
                    
                    <div class="absolute inset-0 flex items-center">
                        <div class="flex-1 pl-6 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0" style="background-color:${iconBg}">
                                <i class="fi fi-sr-hamburger-soda text-xl flex items-center justify-center leading-none" style="color:${iconColor}"></i>
                            </div>
                            <div>
                                <div class="text-[10px] font-bold uppercase opacity-70 tracking-wider" style="color:${txtColor}">
                                    <i class="fi fi-sr-calendar-day mr-1"></i>${dateCode} ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå
                                </div>
                                <div class="text-xl font-bold" style="color:${txtColor}">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                                <div class="text-xs opacity-80" style="color:${txtColor}">‡∏£‡∏´‡∏±‡∏™: ${c.code}</div>
                            </div>
                        </div>
                        <div class="w-[100px] text-center pr-2">
                            ${isUsed ? 
                                '<span class="text-xs font-bold text-white bg-gray-500 px-3 py-1 rounded-full">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>' : 
                                `<i class="fi fi-sr-qr-code text-3xl" style="color:${txtColor}"></i>`
                            }
                        </div>
                    </div>
                </svg>
            </div>`;
            
            box.innerHTML += html;
        });
    }

    function showMyQR() { Swal.fire({title:'<span class="text-orange-600">QR Code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>', html:`<div class="bg-white p-2 inline-block rounded-lg"><img src="https://quickchart.io/qr?text=${currentUser.userData.id}&size=250" class="mx-auto border"></div>`, showCloseButton:true, showConfirmButton:false}); }
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á QR Code ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà) ---
function showCouponQR(code) {
        Swal.fire({
            html: `
                <div class="flex flex-col items-center pt-2 pb-4">
                    
                    <div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-4 shadow-inner ring-4 ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-500" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.83 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v7h6V6c0-2.76-2.24-5-5-5h-1v5zM17 22h2.5v-9h-2.5v9z"/>
                        </svg>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-1">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                    <p class="text-xs text-gray-400 mb-6">‡πÅ‡∏™‡∏î‡∏á QR Code ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô</p>

                    <div class="bg-white p-3 rounded-2xl border-2 border-dashed border-orange-200 shadow-sm mb-6 relative group cursor-pointer transition-transform hover:scale-105">
                        <img src="https://quickchart.io/qr?text=${code}&size=300" class="w-48 h-48 object-contain rounded-lg mx-auto">
                        <div class="absolute -top-3 -right-3 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-md animate-bounce">SCAN ME</div>
                    </div>

                    <div class="bg-gray-50 text-orange-600 font-mono text-xl font-bold px-8 py-3 rounded-xl border border-gray-200 tracking-widest shadow-sm select-all">
                        ${code}
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: { popup: 'rounded-[2rem] overflow-hidden' }
        });
    }

function startScanner(el, type) {
        if(html5QrCode) try{html5QrCode.stop().then(()=>html5QrCode.clear())}catch(e){}
        
        html5QrCode = new Html5Qrcode(el);
        
        // Config ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏ï‡∏£‡∏á‡∏Å‡∏£‡∏≠‡∏ö
        const config = {
            fps: 20, // ‡πÄ‡∏û‡∏¥‡πà‡∏° FPS (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° 10)
            qrbox: { width: 250, height: 250 }, // ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏ö CSS
            aspectRatio: 1.0,
            // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ QR Code (‡∏ï‡∏±‡∏î Barcode ‡∏ó‡∏¥‡πâ‡∏á)
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] 
        };

        html5QrCode.start({ facingMode: "environment" }, config, (txt) => {
            html5QrCode.pause(); 
            processCheckin(type, txt);
        }, () => {}).catch(err => {
            document.getElementById(el).innerHTML = '<div class="text-red-500 p-8 text-center">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>'; 
        });
    }
    function updateDashboard(stats) { 
        if(!stats) return; 
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ Element ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Sponsor ‡πÑ‡∏°‡πà‡∏°‡∏µ Dashboard)
        const totalEl = document.getElementById('stat-total');
        const checkinEl = document.getElementById('stat-checkin');
        
        if (totalEl) totalEl.innerText = stats.total; 
        if (checkinEl) checkinEl.innerText = stats.checkin; 
    }
    // --- SPONSOR MANUAL LOGIC ---

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö Tab (Scan <-> Manual)
    function switchSponsorTab(mode) {
        const bg = document.getElementById('sp-toggle-bg');
        const scanSec = document.getElementById('sponsor-scan-section');
        const manualSec = document.getElementById('sponsor-manual-section');
        const btnScan = document.getElementById('btn-sp-scan');
        const btnManual = document.getElementById('btn-sp-manual');

        if(mode === 'scan') {
            bg.style.left = '4px';
            btnScan.classList.replace('text-gray-500','text-orange-600');
            btnManual.classList.replace('text-orange-600','text-gray-500');
            scanSec.classList.remove('hidden');
            manualSec.classList.add('hidden');
            startScanner('reader-sponsor', 'sponsor');
        } else {
            bg.style.left = '50%';
            btnScan.classList.replace('text-orange-600','text-gray-500');
            btnManual.classList.replace('text-gray-500','text-orange-600');
            scanSec.classList.add('hidden');
            manualSec.classList.remove('hidden');
            if(html5QrCode) try{html5QrCode.stop()}catch(e){}
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Manual
            setupSponsorDateLock();
        }
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin)
    function setupSponsorDateLock() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const day = today.getDate();
        
        const dateSelect = document.getElementById('sp-input-date');
        
        // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        dateSelect.disabled = false;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏Å.‡∏û. 2569 (2026)
        if (year === 2026 && month === 2) {
            if (day === 12) {
                dateSelect.value = "12";
                dateSelect.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            } else if (day === 13) {
                dateSelect.value = "13";
                dateSelect.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            }
        }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
    function submitSponsorManual() {
        const idPart = document.getElementById('sp-input-id').value;
        const datePart = document.getElementById('sp-input-date').value;
        const indexPart = document.getElementById('sp-input-index').value;

        // Validation
        if(idPart.length !== 4) { Swal.fire({icon:'warning', title:'‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å', timer:1500, showConfirmButton:false}); return; }
        if(!indexPart) { Swal.fire({icon:'warning', title:'‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á', timer:1500, showConfirmButton:false}); return; }

        // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™: CVxxxx-12-1
        const fullCode = `CV${idPart}-${datePart}-${indexPart}`;
        
        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
        processCheckin('sponsor', fullCode);
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡πà‡∏≠‡∏¢)
        document.getElementById('sp-input-id').value = '';
        document.getElementById('sp-input-index').value = '';
        document.getElementById('sp-input-id').focus();
    }
  </script>
</body>
</html>
